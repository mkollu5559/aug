#!/bin/bash

qMgrName="$1"
shift
channels=("$@")  # Remaining arguments = channel names

# Run MQSC and capture output
runmqsc "$qMgrName" < /tmp/absChlStatus.mqsc > /tmp/absChlStatus.out

get_status() {
  local channel=$1

  # Check for channel not found
  if grep -A2 "DIS CHS($channel)" /tmp/absChlStatus.out | grep -q "AMQ8420I"; then
    echo "$channel:NOT_FOUND"
    return
  fi

  local chnl=$(grep "CHANNEL($channel)" /tmp/absChlStatus.out | awk '{print $1}')
  local sts=$(grep -A1 "CHANNEL($channel)" /tmp/absChlStatus.out | grep STATUS | awk '{print $1}')

  if [[ "$chnl" == "CHANNEL($channel)" && "$sts" == "STATUS(RUNNING)" ]]; then
    echo "$channel:RUNNING"
  else
    echo "$channel:NOT_RUNNING"
  fi
}

retVal=""
failVal=""

for ch in "${channels[@]}"; do
  status=$(get_status "$ch")

  case "$status" in
    *:RUNNING)
      echo "$ch is Running"
      retVal="${retVal:+$retVal,}$ch"
      ;;
    *:NOT_RUNNING)
      echo "$ch is NOT running"
      failVal="${failVal:+$failVal,}$ch"
      ;;
    *:NOT_FOUND)
      echo "$ch is NOT found"
      failVal="${failVal:+$failVal,}$ch"
      ;;
    *)
      echo "$ch status unknown"
      failVal="${failVal:+$failVal,}$ch"
      ;;
  esac
done

echo "retVal=$retVal"
echo "failVal=$failVal"




-------------------------------


check_abs() {
  passiveQMgr=$1
  instance_id_node1=$2
  channels="$3"

  chk_absChlSts=$(aws ssm send-command \
    --instance-ids "$instance_id_node1" \
    --region "$SSM_REGION" \
    --document-name "AWS-RunShellScript" \
    --comment "ABS Channel Check" \
    --parameters 'commands=[
      "aws s3 cp s3://'"$SSM_SCRIPT_LOC"'/temp/automation/absChlCheck.sh /tmp/absChlCheck.sh",
      "aws s3 cp s3://'"$SSM_SCRIPT_LOC"'/temp/automation/absChlStatus.mqsc /tmp/absChlStatus.mqsc",
      "chmod +x /tmp/absChlCheck.sh",
      "su - mqm -c \"/tmp/absChlCheck.sh '"$passiveQMgr"' '"$channels"'\""
    ]' \
    --output text --query "Command.CommandId")

  ssm_cmd_status=$(ssm_wait "$chk_absChlSts" "$SSM_REGION")

  absChlOutput=$(aws ssm get-command-invocation \
    --command-id "$chk_absChlSts" \
    --instance-id "$instance_id_node1" \
    --region "$SSM_REGION" \
    --query "StandardOutputContent" \
    --output text)

  retVal=$(echo "$absChlOutput" | grep "retVal=" | cut -d '=' -f2-)
  failVal=$(echo "$absChlOutput" | grep "failVal=" | cut -d '=' -f2-)

  if [[ -z "$failVal" ]]; then
    echo "$passiveQMgr","$instance_id_node1","$chk_absChlSts","$ssm_cmd_status","$retVal"
  else
    echo "‚ùå Failed channels: $failVal"
    echo "$passiveQMgr","$instance_id_node1","$chk_absChlSts","$ssm_cmd_status","$failVal"
    exit 1
  fi
}
