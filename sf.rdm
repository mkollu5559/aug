# IR360 Proxy Terraform Rehydration Pipeline

## Overview
This Terraform setup provisions IR360 proxy nodes (EC2 instances) in both `us-gov-west-1` and `us-gov-east-1` regions, one per subnet, using AMI IDs defined in `.tfvars`. Each node is registered via SSM and runs a proxy installation script.

## Directory Structure
```
terraform/
├── backend.tf
├── main.tf
├── output.tf
├── provider.tf
├── variables.tf
├── environments/
│   └── <env>/
│       ├── <env>.tfvars
│       └── backend.tfvars
├── modules/
│   ├── ec2/
│   │   ├── main.tf
│   │   └── install_proxy.sh
│   └── ssm/
```

> ✅ Only `ec2` and `ssm` modules are used. Others are ignored.

## How Rehydration Works

### 1. Environment Setup
Each environment (e.g., `awg-n-nit-intefm`) has its own `.tfvars` and `backend.tfvars`.

Example:
```hcl
ami_name_node1_west = "frs-golden-rhel8_2025-06"
ami_name_node2_west = "frs-golden-rhel8_2025-06"
ami_name_node1_east = "frs-golden-rhel8_2025-06"
ami_name_node2_east = "frs-golden-rhel8_2025-06"
```

Other values like tags, subnets, and SGs are also defined per region.

### 2. EC2 Instances
- 4 EC2 nodes are created:
  - `ec2_node1_west`, `ec2_node2_west`
  - `ec2_node1_east`, `ec2_node2_east`
- Named using format:  
  `IR360-Proxy-HRCE-${environment_tag_name}-<region>-<node_number>`

### 3. SSM Association
Each EC2 node is paired with an SSM association to execute the install script.

## Rehydration Instructions

### ✅ What to Change
Update **only one AMI value** at a time in your `.tfvars`.

### ✅ Where to Update
Path: `terraform/environments/<env>/<env>.tfvars`

Example:
```hcl
ami_name_node1_west = "frs-golden-rhel8_2025-07"
```

### 🔁 Strategy
- ✅ One node at a time per env (recommended)
- Optional: both `node1_west` and `node1_east` at once
- ❌ Do NOT update all 4 at once — availability risk

## Proxy Install Script

- Path: `modules/ec2/install_proxy.sh`
- Auto-uploaded to S3: `s3://<bucket>/ir360/proxy/install_proxy.sh`
- Downloads:  
  `s3://<bucket>/ir360/proxy/ir360_proxy_v7024_SP5_v2.tar.gz`

⚠️ New `.tar.gz` proxy versions must go in the same S3 path or the old one will be reused.

## Pipeline Behavior

- No manual Terraform run is needed.
- On commit to `main`, pipeline:
  1. Applies new AMI to selected node(s)
  2. Triggers SSM association
  3. Runs proxy install script
